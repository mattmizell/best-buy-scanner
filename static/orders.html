<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Orders - Ordering Hub</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f23;
            color: #e0e0e0;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        .header {
            background: linear-gradient(135deg, #1a1a3e 0%, #0f0f23 100%);
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { font-size: 20px; font-weight: 600; color: #fff; }
        .header .subtitle { font-size: 12px; color: #888; margin-top: 4px; }
        .back-link {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #4ecca3;
            text-decoration: none;
            font-size: 14px;
        }

        .container { padding: 16px; max-width: 600px; margin: 0 auto; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-title { font-size: 16px; color: #fff; font-weight: 600; }
        .section-subtitle { font-size: 12px; color: #888; margin-top: 4px; }

        .card {
            background: linear-gradient(135deg, #1a1a3e 0%, #252550 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #333;
        }

        .cart-section {
            background: linear-gradient(135deg, #1a3a2e 0%, #1a1a3e 100%);
            border: 2px solid #4ecca3;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .cart-title { font-size: 18px; font-weight: 700; color: #4ecca3; }
        .cart-summary { font-size: 13px; color: #888; margin-top: 4px; }
        .cart-total { text-align: right; }
        .cart-total-label { font-size: 12px; color: #888; }
        .cart-total-value { font-size: 24px; font-weight: 700; color: #4ecca3; }

        .supplier-group {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .supplier-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .supplier-group-name { font-size: 14px; font-weight: 600; color: #fff; }
        .supplier-group-total { font-size: 14px; color: #4ecca3; font-weight: 600; }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-info { flex: 1; min-width: 0; }
        .cart-item-name { font-size: 13px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cart-item-upc { font-size: 11px; color: #888; }
        .cart-item-qty { font-size: 13px; color: #888; margin: 0 12px; }
        .cart-item-cost { font-size: 13px; color: #4ecca3; font-weight: 600; min-width: 60px; text-align: right; }
        .cart-item-remove { color: #ff6b6b; cursor: pointer; padding: 4px 8px; font-size: 16px; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-draft { background: #444; color: #888; }
        .status-sent { background: rgba(78, 204, 163, 0.2); color: #4ecca3; }
        .status-partial { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .status-received { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .status-closed { background: rgba(156, 39, 176, 0.2); color: #9c27b0; }

        .order-card { cursor: pointer; transition: border-color 0.2s; }
        .order-card:hover { border-color: #4ecca3; }
        .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .order-number { font-size: 16px; font-weight: 600; color: #fff; }
        .order-supplier { font-size: 13px; color: #888; margin-top: 4px; }
        .order-meta { display: flex; gap: 16px; font-size: 12px; color: #888; margin-top: 8px; }
        .order-total { font-size: 18px; font-weight: 700; color: #4ecca3; }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
        }
        .btn-primary { background: #4ecca3; color: #0f0f23; }
        .btn-primary:hover { background: #3db892; }
        .btn-secondary { background: #333; color: #fff; }
        .btn-secondary:hover { background: #444; }
        .btn-danger { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }
        .btn-sm { padding: 8px 12px; font-size: 13px; width: auto; display: inline-block; }

        .empty-state { text-align: center; padding: 40px 20px; color: #888; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        .hidden { display: none !important; }

        .po-count-badge {
            background: #4ecca3;
            color: #0f0f23;
            font-size: 12px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .line-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #1a1a3e;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .line-item-info { flex: 1; min-width: 0; }
        .line-item-name { font-size: 14px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .line-item-upc { font-size: 11px; color: #888; }

        .actions-row { display: flex; gap: 8px; margin-top: 16px; }
        .actions-row .btn { flex: 1; }
    </style>
</head>
<body>
    <div class="header" style="position: relative;">
        <a href="index.html" class="back-link">‚Üê Back</a>
        <h1>View Orders</h1>
        <div class="subtitle">Cart & Purchase Orders</div>
    </div>

    <div class="container">
        <!-- Cart Section (Pending Orders) -->
        <div id="cart-section" class="cart-section hidden">
            <div class="cart-header">
                <div>
                    <div class="cart-title">Pending Orders<span class="po-count-badge" id="po-count-badge">0 POs</span></div>
                    <div class="cart-summary" id="cart-summary">0 items from scanner</div>
                </div>
                <div class="cart-total">
                    <div class="cart-total-label">Total</div>
                    <div class="cart-total-value" id="cart-total">$0.00</div>
                </div>
            </div>

            <div id="cart-suppliers">
                <!-- Supplier groups rendered here -->
            </div>

            <div class="actions-row">
                <button class="btn btn-secondary" onclick="clearCart()">Clear All</button>
                <button class="btn btn-primary" onclick="createAllPOs()">Create POs</button>
            </div>
        </div>

        <!-- Empty Cart State -->
        <div id="empty-cart" class="card">
            <div class="empty-state">
                <div class="empty-state-icon">üì±</div>
                <div style="font-size: 16px; color: #fff; margin-bottom: 8px;">No items in cart</div>
                <div style="font-size: 13px;">Scan items and tap "Order from [Supplier]" to add them</div>
                <a href="scanner.html" class="btn btn-primary" style="margin-top: 16px; display: inline-block; width: auto; padding: 12px 24px;">Open Scanner</a>
            </div>
        </div>

        <!-- Existing Orders Section -->
        <div style="margin-top: 32px;">
            <div class="section-header">
                <div>
                    <div class="section-title">Purchase Orders</div>
                    <div class="section-subtitle">Sent and pending orders</div>
                </div>
            </div>

            <div id="orders-list">
                <div class="empty-state" style="padding: 20px;">
                    <div>No orders yet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal/View could go here -->

    <script>
        const API_BASE = '/api/best-buy';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCart();
            await loadOrders();
        });

        async function loadCart() {
            try {
                const res = await fetch(API_BASE + '/cart');
                const data = await res.json();
                renderCart(data);
            } catch (e) {
                console.error('Failed to load cart:', e);
            }
        }

        function renderCart(data) {
            const cartSection = document.getElementById('cart-section');
            const emptyCart = document.getElementById('empty-cart');

            if (data.total_items === 0) {
                cartSection.classList.add('hidden');
                emptyCart.classList.remove('hidden');
                return;
            }

            cartSection.classList.remove('hidden');
            emptyCart.classList.add('hidden');

            // Update summary
            document.getElementById('po-count-badge').textContent = data.po_count + ' PO' + (data.po_count !== 1 ? 's' : '');
            document.getElementById('cart-summary').textContent = data.total_items + ' item' + (data.total_items !== 1 ? 's' : '') + ' from scanner';
            document.getElementById('cart-total').textContent = '$' + data.total_cost.toFixed(2);

            // Render supplier groups
            const container = document.getElementById('cart-suppliers');
            container.innerHTML = '';

            data.suppliers.forEach(supplier => {
                const group = document.createElement('div');
                group.className = 'supplier-group';

                const header = document.createElement('div');
                header.className = 'supplier-group-header';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'supplier-group-name';
                nameDiv.textContent = supplier.supplier_name + ' (' + supplier.item_count + ' items)';
                header.appendChild(nameDiv);

                const totalDiv = document.createElement('div');
                totalDiv.className = 'supplier-group-total';
                totalDiv.textContent = '$' + supplier.total_cost.toFixed(2);
                header.appendChild(totalDiv);

                group.appendChild(header);

                supplier.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';

                    const info = document.createElement('div');
                    info.className = 'cart-item-info';
                    const name = document.createElement('div');
                    name.className = 'cart-item-name';
                    name.textContent = item.product_name;
                    const upc = document.createElement('div');
                    upc.className = 'cart-item-upc';
                    upc.textContent = item.upc;
                    info.appendChild(name);
                    info.appendChild(upc);
                    itemDiv.appendChild(info);

                    const qty = document.createElement('div');
                    qty.className = 'cart-item-qty';
                    qty.textContent = 'x' + item.quantity;
                    itemDiv.appendChild(qty);

                    const cost = document.createElement('div');
                    cost.className = 'cart-item-cost';
                    cost.textContent = '$' + item.line_total.toFixed(2);
                    itemDiv.appendChild(cost);

                    const remove = document.createElement('div');
                    remove.className = 'cart-item-remove';
                    remove.textContent = '√ó';
                    remove.onclick = () => removeCartItem(item.id);
                    itemDiv.appendChild(remove);

                    group.appendChild(itemDiv);
                });

                container.appendChild(group);
            });
        }

        async function removeCartItem(itemId) {
            try {
                await fetch(API_BASE + '/cart/' + itemId, { method: 'DELETE' });
                await loadCart();
            } catch (e) {
                console.error('Failed to remove item:', e);
            }
        }

        async function clearCart() {
            if (!confirm('Clear all items from cart?')) return;
            try {
                await fetch(API_BASE + '/cart', { method: 'DELETE' });
                await loadCart();
            } catch (e) {
                console.error('Failed to clear cart:', e);
            }
        }

        async function createAllPOs() {
            if (!confirm('Create purchase orders from cart?')) return;
            try {
                const res = await fetch(API_BASE + '/cart/create-pos', { method: 'POST' });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Failed to create POs');
                }
                const data = await res.json();
                alert('Created ' + data.pos_created + ' purchase order' + (data.pos_created !== 1 ? 's' : '') + '!');
                await loadCart();
                await loadOrders();
            } catch (e) {
                console.error('Failed to create POs:', e);
                alert(e.message);
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch(API_BASE + '/orders?limit=20');
                const orders = await res.json();
                renderOrders(orders);
            } catch (e) {
                console.error('Failed to load orders:', e);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';

            if (orders.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.style.padding = '20px';
                emptyDiv.textContent = 'No orders yet';
                container.appendChild(emptyDiv);
                return;
            }

            orders.forEach(o => {
                const card = document.createElement('div');
                card.className = 'card order-card';
                card.onclick = () => window.location.href = 'order-detail.html?id=' + o.id;

                const header = document.createElement('div');
                header.className = 'order-header';

                const info = document.createElement('div');
                const poNum = document.createElement('div');
                poNum.className = 'order-number';
                poNum.textContent = o.po_number;
                const supplier = document.createElement('div');
                supplier.className = 'order-supplier';
                supplier.textContent = o.supplier_name;
                info.appendChild(poNum);
                info.appendChild(supplier);

                const badge = document.createElement('span');
                badge.className = 'status-badge status-' + o.status;
                badge.textContent = o.status;

                header.appendChild(info);
                header.appendChild(badge);
                card.appendChild(header);

                const footer = document.createElement('div');
                footer.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-end;';

                const meta = document.createElement('div');
                meta.className = 'order-meta';
                const itemsSpan = document.createElement('span');
                itemsSpan.textContent = o.total_items + ' items';
                const dateSpan = document.createElement('span');
                dateSpan.textContent = new Date(o.created_at).toLocaleDateString();
                meta.appendChild(itemsSpan);
                meta.appendChild(dateSpan);

                const total = document.createElement('div');
                total.className = 'order-total';
                total.textContent = '$' + o.total_cost.toFixed(2);

                footer.appendChild(meta);
                footer.appendChild(total);
                card.appendChild(footer);

                container.appendChild(card);
            });
        }
    </script>
</body>
</html>
